name: Sync audit-netlify with master

on:
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: sync-audit-netlify
  cancel-in-progress: false

jobs:
  sync:
    runs-on: ubuntu-24.04

    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Configure Git identity
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Fetch branches
        run: |
          git fetch origin master audit-netlify --prune

      - name: Verify branches exist
        run: |
          git show-ref --verify --quiet refs/remotes/origin/master
          git show-ref --verify --quiet refs/remotes/origin/audit-netlify

      - name: Capture SHAs
        id: shas
        run: |
          echo "master=$(git rev-parse --short origin/master)" >> $GITHUB_OUTPUT
          echo "audit_before=$(git rev-parse --short origin/audit-netlify)" >> $GITHUB_OUTPUT

      - name: Reset audit-netlify to remote
        run: |
          git switch audit-netlify
          git reset --hard origin/audit-netlify

      - name: Merge master into audit-netlify
        run: |
          git merge --no-ff -m "merge(audit-netlify): sync from master" origin/master

      - name: Summary
        run: |
          echo "### audit-netlify synced from master" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**master:** \`${{ steps.shas.outputs.master }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**audit-netlify (before):** \`${{ steps.shas.outputs.audit_before }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**audit-netlify (after):** \`$(git rev-parse --short HEAD)\`" >> $GITHUB_STEP_SUMMARY

      - name: Push audit-netlify
        run: |
          git push origin audit-netlify
