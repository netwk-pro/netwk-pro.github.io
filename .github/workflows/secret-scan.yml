# .github/workflows/secret-scan.yml
#
# Copyright Â© 2025 Network Pro Strategies (Network Proâ„¢)
# SPDX-License-Identifier: CC-BY-4.0 OR GPL-3.0-or-later
# This file is part of Network Pro.

name: Secret Scan (Gitleaks)

on:
  pull_request:
  schedule:
    - cron: '0 8 * * *' # nightly scan at 8 AM UTC
  workflow_dispatch:

jobs:
  gitleaks-scan:
    runs-on: ubuntu-24.04
    permissions:
      contents: read
      security-events: write
      issues: write
    env:
      CODEQL_ACTION_ANALYSIS_KEY: gitleaks
    steps:
      # ---------------------------------------------------------------------
      # Checkout the full repo history (needed for Gitleaks to scan all commits)
      # ---------------------------------------------------------------------
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0

      # ---------------------------------------------------------------------
      # Run Gitleaks scan (SARIF format)
      # ---------------------------------------------------------------------
      - name: Run Gitleaks scan
        id: gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }}
          GITLEAKS_REPORT_PATH: gitleaks-report.sarif
          GITLEAKS_FORMAT: sarif

      # ---------------------------------------------------------------------
      # Upload SARIF to GitHub Security (Code Scanning)
      # Only in trusted repo context (not from forks)
      # ---------------------------------------------------------------------
      - name: Upload SARIF report to GitHub Security tab
        if: always() && (github.event.pull_request.head.repo.full_name == github.repository || github.event_name != 'pull_request')
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: gitleaks-report.sarif

      # ---------------------------------------------------------------------
      # Upload SARIF as workflow artifact (for maintainers)
      # ---------------------------------------------------------------------
      - name: Upload SARIF artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: gitleaks-sarif-report
          path: gitleaks-report.sarif

      # ---------------------------------------------------------------------
      # Public-safe summary output in job summary
      # ---------------------------------------------------------------------
      - name: Post Gitleaks summary
        if: always()
        run: |
          echo "### ðŸ§© Gitleaks Scan Summary" >> $GITHUB_STEP_SUMMARY
          if [ -s gitleaks-report.sarif ]; then
            count=$(jq '[.runs[].results[]] | length' gitleaks-report.sarif)
            if [ "$count" -gt 0 ]; then
              echo "ðŸš¨ **$count potential secret$( [ "$count" -ne 1 ] && echo "s" ) detected!**" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              jq -r '.runs[].results[] | "- \(.message.text)"' gitleaks-report.sarif | head -n 10 >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "_Full SARIF report available in Artifacts section or Security tab._" >> $GITHUB_STEP_SUMMARY
            else
              echo "âœ… No secrets detected." >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "âš ï¸ No report file found." >> $GITHUB_STEP_SUMMARY
          fi

      # ---------------------------------------------------------------------
      # Create issue if secrets found (trusted repo context only)
      # ---------------------------------------------------------------------
      - name: Create issue for detected secrets
        if: failure() && (github.event.pull_request.head.repo.full_name == github.repository || github.event_name != 'pull_request')
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issueTitle = `ðŸš¨ Secret(s) detected in ${context.repo.repo}`;
            const issueBody = `Gitleaks found potential secrets in commit ${context.sha}.\n\nCheck workflow logs, Security tab, and artifacts for details.`;
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: issueTitle,
              body: issueBody,
              labels: ['security', 'gitleaks']
            });

      # ---------------------------------------------------------------------
      # Send ntfy alert if leaks found (trusted repo context only)
      # ---------------------------------------------------------------------
      - name: Send ntfy notification
        if: failure() && (github.event.pull_request.head.repo.full_name == github.repository || github.event_name != 'pull_request')
        run: |
          curl -d "ðŸš¨ Gitleaks found secrets in repo: $GITHUB_REPOSITORY on commit $GITHUB_SHA" \
               https://ntfy.neteng.pro/${{ secrets.NTFY_TOPIC }}
