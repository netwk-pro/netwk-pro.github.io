# .github/workflows/branch-guard.yml
#
# Copyright Â© 2025 Network Pro Strategies (Network Proâ„¢)
# SPDX-License-Identifier: CC-BY-4.0 OR GPL-3.0-or-later
# This file is part of Network Pro
#
# Warns if commits are pushed directly to master/main instead of via PR.
# Does NOT block the commit â€” it just posts a workflow summary and log warning.

name: Branch Guard

on:
  push:
    branches:
      - master
      - main

permissions:
  contents: read

jobs:
  warn-direct-commit:
    runs-on: ubuntu-24.04
    steps:
      - name: Check commit source
        run: |
          commit_msg="${{ github.event.head_commit.message }}"
          actor="${{ github.actor }}"
          branch="${GITHUB_REF##*/}"

          echo "ðŸ“ Commit message: $commit_msg"
          echo "ðŸ‘¤ Actor: $actor"
          echo "ðŸŒ¿ Branch: $branch"

          # Define known safe patterns (merge or bot commits)
          if echo "$commit_msg" | grep -Eq "Merge pull request|See merge request|Merge branch|(#\d+)$"; then
            echo "âœ… Merge-related commit detected â€” no warning."
            exit 0
          fi

          if [[ "$actor" == "dependabot[bot]" ]] || [[ "$actor" == "renovate[bot]" ]] || [[ "$actor" == "github-actions[bot]" ]]; then
            echo "ðŸ¤– Bot commit detected â€” skipping warning."
            exit 0
          fi

          # Otherwise, warn for direct commits
          echo "::warning ::âš ï¸ Direct commit to $branch by $actor."
          {
            echo "### âš ï¸ Direct Commit Detected"
            echo "A commit was pushed directly to \`$branch\` by **$actor**."
            echo ""
            echo "ðŸ’¡ It's recommended to use pull requests for traceability and CI validation."
          } >> $GITHUB_STEP_SUMMARY
